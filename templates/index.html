<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <title>Reisų Rezultatai</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        .weekend-button {
            background-color: transparent;
            border: 1px solid #ccc;
            transition: background-color 0.3s;
        }
        .weekend-button.active {
            background-color: orange;
        }
        #clock {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            .table-responsive-stack .table-responsive-stack-thead {
                display: none;
            }
            .table-responsive-stack tr {
                display: block;
                border: 1px solid #ccc;
                margin-bottom: 1em;
                border-radius: 4px;
                font-size: 1.1em;
            }
            .table-responsive-stack td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            .table-responsive-stack td::before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                text-align: left;
                font-weight: bold;
            }
            .table-container {
                max-width: 100%;
                overflow-x: auto;
            }
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function Clock() {
            const [time, setTime] = React.useState(new Date());

            React.useEffect(() => {
                const timer = setInterval(() => {
                    setTime(new Date());
                }, 1000);

                return () => {
                    clearInterval(timer);
                };
            }, []);

            const formatTime = (date) => {
                const options = {
                    timeZone: 'Europe/Vilnius',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                return date.toLocaleTimeString('lt-LT', options);
            };

            return <div id="clock">{formatTime(time)}</div>;
        }

        function App() {
            const [visiIrasai, setVisiIrasai] = React.useState(
                JSON.parse('{{ visi_irasai | safe }}').sort((a, b) => new Date(b.data) - new Date(a.data))
            );
            const [bendraSuma, setBendraSuma] = React.useState(JSON.parse('{{ bendra_suma | safe }}'));
            const [selectedMonth, setSelectedMonth] = React.useState('{{ selected_month }}');
            const [isSavaitgalis, setIsSavaitgalis] = React.useState(false);
            const [currentDate, setCurrentDate] = React.useState('');
            const carNumbers = JSON.parse('{{ car_numbers | safe }}');
            const user = JSON.parse('{{ user | safe }}');

            React.useEffect(() => {
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                setCurrentDate(formattedDate);
            }, []);

            const handleMonthChange = (event) => {
                setSelectedMonth(event.target.value);
            };

            const handleSavaitgalisToggle = () => {
                setIsSavaitgalis(!isSavaitgalis);
            };

            const handleSubmit = (event) => {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("index") }}',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            // Pridėti naują įrašą į sąrašo pradžią
                            setVisiIrasai(prevIrasai => [response.newRecord, ...prevIrasai]);
                            // Atnaujinti bendrą sumą
                            setBendraSuma(prevSuma => ({
                                tasku_kiekis: prevSuma.tasku_kiekis + response.newRecord.tasku_kiekis,
                                km_kiekis: prevSuma.km_kiekis + response.newRecord.km_kiekis,
                                pakrautos_paletes: prevSuma.pakrautos_paletes + response.newRecord.pakrautos_paletes,
                                tara: prevSuma.tara + response.newRecord.tara,
                                atgalines_paletes: prevSuma.atgalines_paletes + response.newRecord.atgalines_paletes,
                                eur_uz_reisa: prevSuma.eur_uz_reisa + response.newRecord.eur_uz_reisa
                            }));
                            // Išvalyti formos laukus
                            form.reset();
                            setIsSavaitgalis(false);
                            alert(response.message);
                        } else {
                            alert('Klaida: ' + response.message);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("AJAX klaida:", textStatus, errorThrown);
                        alert('Įvyko klaida. Bandykite dar kartą.');
                    }
                });
            };

            const handleDelete = (id) => {
                if (confirm('Ar tikrai norite ištrinti šį įrašą?')) {
                    $.ajax({
                        url: '/delete/' + id,
                        type: 'GET',
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                // Pašaliname įrašą iš sąrašo
                                setVisiIrasai(prevIrasai => prevIrasai.filter(irasas => irasas.id !== id));
                                
                                // Atnaujiname bendrą sumą
                                setBendraSuma(response.newTotal);
                                
                                alert(response.message);
                            } else {
                                alert('Klaida: ' + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Klaida:', error);
                            alert('Įvyko klaida bandant ištrinti įrašą.');
                        }
                    });
                }
            };

            return (
                <div className="container mt-5">
                    <Clock />
                    <h1 className="mb-4">Reisų Rezultatai</h1>
                    
                    <div className="mb-3">
                        <a href="/logout" className="btn btn-danger mr-2">Atsijungti</a>
                        <a href="/grafikai" className="btn btn-info mr-2">Peržiūrėti grafikus</a>
                        <a href="/store_catalog" className="btn btn-success mr-2">Parduotuvių ir atgalinių katalogas</a>
                        {user.is_admin && (
                            <a href="/admin" className="btn btn-warning">Administratoriaus skydelis</a>
                        )}
                    </div>

                    <form action="/" method="GET" className="mb-4">
                        <div className="form-group">
                            <label htmlFor="month">Pasirinkite mėnesį:</label>
                            <input 
                                type="month" 
                                id="month" 
                                name="month" 
                                className="form-control" 
                                value={selectedMonth}
                                onChange={handleMonthChange}
                            />
                        </div>
                        <button type="submit" className="btn btn-primary">Filtruoti</button>
                    </form>

                    <h2>Pridėti naują įrašą</h2>
                    <form onSubmit={handleSubmit} className="mb-4">
                        <div className="form-row">
                            <div className="form-group col-md-6">
                                <label htmlFor="data">Data:</label>
                                <input type="date" id="data" name="data" className="form-control" required value={currentDate} />
                            </div>
                            <div className="form-group col-md-6">
                                <label htmlFor="auto_nr">Automobilio numeris:</label>
                                <select id="auto_nr" name="auto_nr" className="form-control" required>
                                    {carNumbers.map(number => (
                                        <option key={number} value={number}>{number}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <div className="form-row">
                            <div className="form-group col-md-4">
                                <label htmlFor="km_kiekis">Kilometrų kiekis:</label>
                                <input type="number" step="0.01" id="km_kiekis" name="km_kiekis" className="form-control" required />
                            </div>
                            <div className="form-group col-md-4">
                                <label htmlFor="tasku_kiekis">Taškų kiekis:</label>
                                <input type="number" step="0.01" id="tasku_kiekis" name="tasku_kiekis" className="form-control" required />
                            </div>
                            <div className="form-group col-md-4">
                                <label htmlFor="pakrautos_paletes">Pakrautos paletės:</label>
                                <input type="number" step="0.01" id="pakrautos_paletes" name="pakrautos_paletes" className="form-control" required />
                            </div>
                        </div>
                        <div className="form-row">
                            <div className="form-group col-md-4">
                                <label htmlFor="atgalines_paletes">Atgalinės paletės:</label>
                                <input type="number" step="0.01" id="atgalines_paletes" name="atgalines_paletes" className="form-control" required />
                            </div>
                            <div className="form-group col-md-4">
                                <label htmlFor="tara">Tara:</label>
                                <input type="number" step="0.01" id="tara" name="tara" className="form-control" required />
                            </div>
                            <div className="form-group col-md-4">
                                <label>Savaitgalis:</label>
                                <button 
                                    type="button"
                                    className={`btn btn-block weekend-button ${isSavaitgalis ? 'active' : ''}`}
                                    onClick={handleSavaitgalisToggle}
                                    title="Savaitgalį mokami papildomi 20% nuo atliktų darbų"
                                >
                                    Savaitgalis
                                </button>
                                <input type="hidden" name="savaitgalis" value={isSavaitgalis ? 'true' : 'false'} />
                            </div>
                        </div>
                        <button type="submit" className="btn btn-success">Pridėti įrašą</button>
                    </form>

                    <div className="mb-4">
                        <h2>Bendra suma</h2>
                        <div className="table-container">
                            <table className="table table-bordered table-responsive-stack">
                                <thead className="table-responsive-stack-thead">
                                    <tr>
                                        <th>Taškų kiekis</th>
                                        <th>Kilometrų kiekis</th>
                                        <th>Pakrautos paletės</th>
                                        <th>Tara</th>
                                        <th>Atgalinės paletės</th>
                                        <th>EUR už reisą</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td data-label="Taškų kiekis">{bendraSuma.tasku_kiekis.toFixed(2)}</td>
                                        <td data-label="Kilometrų kiekis">{bendraSuma.km_kiekis.toFixed(2)}</td>
                                        <td data-label="Pakrautos paletės">{bendraSuma.pakrautos_paletes.toFixed(2)}</td>
                                        <td data-label="Tara">{bendraSuma.tara.toFixed(2)}</td>
                                        <td data-label="Atgalinės paletės">{bendraSuma.atgalines_paletes.toFixed(2)}</td>
                                        <td data-label="EUR už reisą">{bendraSuma.eur_uz_reisa.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h2>Įrašų sąrašas</h2>
                    <div className="table-container">
                        <table className="table table-striped table-responsive-stack">
                            <thead className="table-responsive-stack-thead">
                                <tr>
                                    <th>Data</th>
                                    <th>Auto Nr.</th>
                                    <th>Taškai</th>
                                    <th>KM</th>
                                    <th>Paletės</th>
                                    <th>Tara</th>
                                    <th>Atg. paletės</th>
                                    <th>EUR</th>
                                    <th>Savaitgalis</th>
                                    <th>Veiksmai</th>
                                </tr>
                            </thead>
                            <tbody>
                                {visiIrasai.map(irasas => (
                                    <tr key={irasas.id} id={`row-${irasas.id}`}>
                                        <td data-label="Data">{irasas.data}</td>
                                        <td data-label="Auto Nr.">{irasas.auto_nr}</td>
                                        <td data-label="Taškai">{irasas.tasku_kiekis.toFixed(2)}</td>
                                        <td data-label="KM">{irasas.km_kiekis.toFixed(2)}</td>
                                        <td data-label="Paletės">{irasas.pakrautos_paletes.toFixed(2)}</td>
                                        <td data-label="Tara">{irasas.tara.toFixed(2)}</td>
                                        <td data-label="Atg. paletės">{irasas.atgalines_paletes.toFixed(2)}</td>
                                        <td data-label="EUR">{irasas.eur_uz_reisa.toFixed(2)}</td>
                                        <td data-label="Savaitgalis">{irasas.savaitgalis ? 'Taip' : 'Ne'}</td>
                                        <td data-label="Veiksmai">
                                            <a href={`/edit/${irasas.id}`} className="btn btn-sm btn-warning mr-2">Redaguoti</a>
                                            <button onClick={() => handleDelete(irasas.id)} className="btn btn-sm btn-danger">Ištrinti</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>